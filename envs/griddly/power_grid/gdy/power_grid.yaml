  Version: '0.1'
  Environment:
    Name: PowerGrid
    Description: Metta - Foraging
    Variables:
      # Altar
      - Name: conf:altar:cost
        InitialValue: 50
      - Name: conf:altar:cooldown
        InitialValue: 2
      - Name: stats:action:use:altar
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:altar
        InitialValue: 0
        PerPlayer: true
      # Charger
      - Name: conf:charger:cooldown
        InitialValue: 2
      - Name: stats:action:use:charger
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:gained:met
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:gained:met:1
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:gained:met:2
        InitialValue: 0
        PerPlayer: true

      # Generator
      - Name: conf:generator:cooldown
        InitialValue: 50
      - Name: stats:action:use:generator
        InitialValue: 0
        PerPlayer: true
      - Name: stats:resource:collected
        InitialValue: 0
        PerPlayer: true

      # Milestone
      - Name: stats:milestones
        InitialValue: 0
        PerPlayer: true

      # Agent Upkeep
      - Name: conf:agent:energy:regen
        InitialValue: 0
      - Name: conf:agent:initial_energy
        InitialValue: 100
      - Name: stats:action:use
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:gained
        InitialValue: 0
        PerPlayer: true

      # Movement
      - Name: conf:cost:move
        InitialValue: 0
      - Name: stats:action:move
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:move
        InitialValue: 0
        PerPlayer: true
      - Name: conf:cost:rotate
        InitialValue: 0
      - Name: stats:action:rotate
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:rotate
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:frozen
        InitialValue: 0
        PerPlayer: true
      - Name: stats:agent:frozen:ticks
        InitialValue: 0
        PerPlayer: true

      # Shield
      - Name: conf:cost:shield
        InitialValue: 0
      - Name: conf:cost:shield:upkeep
        InitialValue: 1
      - Name: stats:agent:shield:ticks
        InitialValue: 0
        PerPlayer: true
      - Name: stats:action:shield
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:shield:upkeep
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:shield:defence
        InitialValue: 0
        PerPlayer: true

      # Attack
      - Name: conf:cost:attack
        InitialValue: 20
      - Name: conf:attack:damage
        InitialValue: 15
      - Name: conf:attack:freeze_duration
        InitialValue: 15
      - Name: conf:cost:frozen
        InitialValue: 1
      - Name: stats:action:attack
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:attack
        InitialValue: 0
        PerPlayer: true

      # Metabolism
      - Name: agent:met:1:resource
        PerPlayer: true
        InitialValue: 0
      - Name: agent:met:2:resource
        PerPlayer: true
        InitialValue: 0
      - Name: conf:agent:energy:met:1
        PerPlayer: true
        InitialValue: 5
      - Name: conf:agent:energy:met:2
        PerPlayer: true
        InitialValue: 10

      # debug variables, used for webui
      - Name: debug:agent:energy
        InitialValue: 0
        PerPlayer: true
      - Name: debug:agent:met:1
        InitialValue: 0
        PerPlayer: true
      - Name: debug:agent:met:2
        InitialValue: 0
        PerPlayer: true

      # variables for controlling rendering
      - Name: render:agent:attacked
        InitialValue: 0
        PerPlayer: true

      - Name: tmp:v1
        InitialValue: 0
      - Name: tmp:v2
        InitialValue: 0

    Observers:
      VectorAgent:
        Type: VECTOR
        Width: 11
        Height: 11
        TrackAvatar: true
        RotateWithAvatar: true
        IncludeVariables: true
        # IncludeRotation: true
      GlobalSpriteObserver:
        TileSize: 32
        Type: SPRITE_2D
        RotateAvatarImage: true
        BackgroundTile: oryx/oryx_fantasy/floor1-0.png
        Shader:
            ObjectVariables: [ agent:energy, agent:energy ]
            ObserverAvatarMode: DARKEN
    Player:
      Count: 7
      AvatarObject: agent

    Levels:
      - >
        W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W
        W

        W   A1/o   .   o   o   o   a   o   o   A2/o  o   o   o   o   o   o   o   A3/o
        W

        W   o   o   .   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   o   o   .   o   o   c   o   a   o   o   o   o   o   o   o   o   o
        W

        W   o   o   g   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   o   o   o   o   o   c   o   o   o   o   g   o   o   o   o   o   o
        W

        W   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   A4/o   o   g   o   o   o   o   o   g   o   o   o   o   o   g   o   A5/o
        W

        W   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   o   o   o   o   o   g   o   o   o   o   o   o   o   o   o   o   o
        W

        W   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   o   o   o   o   o   o   o   o   g   o   o   g   o   o   o   o   o
        W

        W   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o   o
        W

        W   A6/o   o   o   o   o   o   o   o   o   A7/o   o   o   o   o   o   o   o
        W

        W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W
        W

  Objects:
    - Name: wall
      MapCharacter: W
      Z: 1
      Observers:
        GlobalSpriteObserver:
          - TilingMode: WALL_16
            Image:
              - oryx/oryx_fantasy/wall2-0.png
              - oryx/oryx_fantasy/wall2-1.png
              - oryx/oryx_fantasy/wall2-2.png
              - oryx/oryx_fantasy/wall2-3.png
              - oryx/oryx_fantasy/wall2-4.png
              - oryx/oryx_fantasy/wall2-5.png
              - oryx/oryx_fantasy/wall2-6.png
              - oryx/oryx_fantasy/wall2-7.png
              - oryx/oryx_fantasy/wall2-8.png
              - oryx/oryx_fantasy/wall2-9.png
              - oryx/oryx_fantasy/wall2-10.png
              - oryx/oryx_fantasy/wall2-11.png
              - oryx/oryx_fantasy/wall2-12.png
              - oryx/oryx_fantasy/wall2-13.png
              - oryx/oryx_fantasy/wall2-14.png
              - oryx/oryx_fantasy/wall2-15.png

    - Name: milestone
      MapCharacter: o
      Z: 1
      Variables:
        - Name: milestone:visited
          InitialValue: 0
      Observers:
        GlobalSpriteObserver:
          - Image: oryx/oryx_fantasy/floor1-1.png
          - Image: oryx/oryx_fantasy/floor1-0.png
          - Image: oryx/oryx_fantasy/floor6-0.png
          - Image: oryx/oryx_fantasy/floor7-0.png

    - Name: generator
      Z: 1
      MapCharacter: g
      Variables:
        - Name: generator:ready
          InitialValue: 0
        - Name: generator:resource
          InitialValue: 1
      Observers:
        GlobalSpriteObserver:
          - Image: oryx/oryx_fantasy/ore-0.png
          - Image: oryx/oryx_fantasy/ore-1.png
          - Image: oryx/oryx_fantasy/ore-2.png
          - Image: oryx/oryx_fantasy/ore-3.png
          - Image: oryx/oryx_fantasy/ore-4.png
          - Image: oryx/oryx_fantasy/ore-5.png
          - Image: oryx/oryx_fantasy/ore-6.png
      InitialActions:
        - Action: generator:reset
          ActionId: 1
          Randomize: True

    - Name: charger
      Z: 1
      MapCharacter: c
      Variables:
        - Name: charger:ready
          InitialValue: 0
      Observers:
        GlobalSpriteObserver:
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_pda_A.png
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_pda_B.png
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_pda_C.png
      InitialActions:
        - Action: charger:reset
          ActionId: 1

    - Name: altar
      Z: 1
      MapCharacter: a
      Variables:
        - Name: altar:ready
          InitialValue: 0
      Observers:
        GlobalSpriteObserver:
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_heart_clear.png
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_heart_full.png
      InitialActions:
        - Action: altar:reset
          ActionId: 1

    - Name: agent
      MapCharacter: A
      Z: 10
      Variables:
        - Name: agent:id
          InitialValue: 0
        - Name: agent:energy
          InitialValue: 0
        - Name: agent:shield
          InitialValue: 0
        - Name: agent:frozen
          InitialValue: 0

        - Name: agent:met:1
          InitialValue: 0
        - Name: agent:met:2
          InitialValue: 0

      Observers:
        GlobalSpriteObserver:
          # Shield off
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_astronaut_u1.png
          # Shield on
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_beast_u1.png
          # Frozen
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_void_d1.png
          # Attacked
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_alien_elder_u1.png
      InitialActions:
        - Action: agent:tick
          Delay: 1
          ActionId: 1
        - Action: agent:init
          ActionId: 1
          Randomize: true

  Actions:
    - Name: rotate
      InputMapping:
          Inputs:
            1:
              Description: Face down
              OrientationVector: [0, 1]
            2:
              Description: Face left
              OrientationVector: [-1, 0]
            3:
              Description: Face right
              OrientationVector: [1, 0]
            4:
              Description: Face Up
              OrientationVector: [0, -1]

      Behaviours:
        - Src:
            Object: agent
            Preconditions:
              - gte: [ agent:energy, conf:cost:rotate ]
              - eq: [ agent:frozen, 0 ]
            Commands:
              - rot: _dir
              - sub: [ agent:energy, conf:cost:rotate ]
              - incr: stats:action:rotate
              - add: [ stats:energy:used:rotate, conf:cost:rotate ]
          Dst:
            Object: agent


    - Name: move
      InputMapping:
        Relative: true
        Inputs:
          1:
            VectorToDest: [ 0, -1 ]
            Description: "move forward"
          2:
            VectorToDest: [ 0, 1 ]
            Description: "move backward"

      Behaviours:
        - Src:
            Object: agent
            Preconditions:
              - gte: [ agent:energy, conf:cost:move ]
              - eq: [ agent:frozen, 0 ]
            Commands:
              - sub: [ agent:energy, conf:cost:move ]
              - incr: stats:action:move
              - add: [ stats:energy:used:move, conf:cost:move ]
              - if:
                  Conditions:
                      eq: [ dst.milestone:visited, 0 ]
                  OnTrue:
                      - set: [ dst.milestone:visited, 1 ]
                      - incr: [ stats:milestones ]
                      - reward: 1
              - mov: _dest
          Dst:
            Object: [ milestone ]
            Commands:
                - set_tile: 1

        - Src:
            Object: agent
            Preconditions:
              - gte: [ agent:energy, conf:cost:move ]
              - eq: [ agent:frozen, 0 ]
            Commands:
              - sub: [ agent:energy, conf:cost:move ]
              - incr: stats:action:move
              - add: [ stats:energy:used:move, conf:cost:move ]
              - mov: _dest
          Dst:
            Object: [ _empty ]

    - Name: use
      InputMapping:
        Relative: true
        Inputs:
          1:
            VectorToDest: [ 0, -1 ]
            Description: "use"
      Behaviours:
        # Use a generator
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
                - eq: [ dst.generator:ready, 1 ]
                - or:
                    - eq: [ agent:met:1:resource, dst.generator:resource ]
                    - eq: [ agent:met:2:resource, dst.generator:resource ]
            Commands:
              - incr: stats:action:use:generator
              - incr: stats:resource:collected
              - reward: 1
              - if:
                  Conditions:
                      eq: [ agent:met:1:resource, dst.generator:resource ]
                  OnTrue:
                      - incr: [ agent:met:1 ]
              - if:
                  Conditions:
                      eq: [ agent:met:2:resource, dst.generator:resource ]
                  OnTrue:
                      - incr: [ agent:met:2 ]
          Dst:
            Object: generator
            Commands:
              - set_tile: 0
              - set: [ generator:ready, 0 ]
              - exec:
                  Action: generator:reset
                  ActionId: generator:resource
                  Delay: conf:generator:cooldown

        # Use a charger
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
                - eq: [ dst.charger:ready, 1 ]
                - gte: [ agent:met:1, 1 ]
            Commands:
              - incr: stats:action:use:charger
              - reward: 1
              - decr: agent:met:1
              - add: [ agent:energy, conf:agent:energy:met:1 ]
              - add: [ stats:energy:gained:met, conf:agent:energy:met:1 ]
              - add: [ stats:energy:gained:met:1, conf:agent:energy:met:1 ]

              - if:
                  Conditions:
                      gte: [ agent:met:2, 1 ]
                  OnTrue:
                      - decr: agent:met:2
                      - add: [ agent:energy, conf:agent:energy:met:2 ]
                      - add: [ stats:energy:gained:met, conf:agent:energy:met:2 ]
                      - add: [ stats:energy:gained:met:2, conf:agent:energy:met:2 ]
                      - reward: 2
          Dst:
            Object: charger
            Commands:
              - set_tile: 1
              - set: [ charger:ready, 0 ]
              - exec:
                  Action: charger:reset
                  ActionId: 1
                  Delay: conf:charger:cooldown

        # Use Altar
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
                - eq: [ dst.altar:ready, 1 ]
                - gte: [ agent:energy, conf:altar:cost ]
            Commands:
              - incr: stats:action:use:altar
              - sub: [ agent:energy, conf:altar:cost ]
              - add: [ stats:energy:used:altar, conf:altar:cost ]
              - reward: 100
          Dst:
            Object: altar
            Commands:
              - set_tile: 1
              - set: [ altar:ready, 0 ]
              - exec:
                  Action: altar:reset
                  ActionId: 1
                  Delay: conf:altar:cooldown

    - Name: shield
      InputMapping:
        Relative: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
            Description: "Toggle Shield"

      Behaviours:
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
            Commands:
              - if:
                    Conditions:
                      eq: [ agent:shield, 1 ]
                    OnTrue:
                      - set: [ agent:shield, 0 ]
                    OnFalse:
                      - set: [ agent:shield, 1 ]

              - incr: stats:action:shield
          Dst:
            Object: agent

    - Name: attack
      InputMapping:
        Relative: true
        Inputs:
          1:
            VectorToDest: [ -1, -1 ]
            Description: "attack 1"
          2:
            VectorToDest: [ 0, -1 ]
            Description: "attack 2"
          3:
            VectorToDest: [ 1, -1 ]
            Description: "attack 3"
          4:
            VectorToDest: [ -1, -2 ]
            Description: "attack 4"
          5:
            VectorToDest: [ 0, -2 ]
            Description: "attack 5"
          6:
            VectorToDest: [ 1, -2 ]
            Description: "attack 6"
          7:
            VectorToDest: [ -1, -3 ]
            Description: "attack 7"
          8:
            VectorToDest: [ 0, -3 ]
            Description: "attack 8"
          9:
            VectorToDest: [ 1, -3 ]
            Description: "attack 9"

      Behaviours:
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
                - gte: [ agent:energy, conf:cost:attack ]
            Commands:
              - sub: [ agent:energy, conf:cost:attack ]
              - add: [ stats:energy:used:attack, conf:cost:attack ]
              - incr: stats:action:attack

          Dst:
            Object: agent
            Commands:
              - if:
                    Conditions:
                      eq: [ agent:shield, 1 ]
                    OnTrue:
                      - sub: [ agent:energy, conf:attack:damage ]
                      - add: [ stats:energy:used:shield:defence, conf:attack:damage ]
                      - set: [ render:agent:attacked, 2 ]
                      - if:
                          Conditions:
                            lt: [ agent:energy, 0 ]
                          OnTrue:
                            - set: [ agent:frozen, conf:attack:freeze_duration ]
                            - set: [ agent:shield, 0 ]
                            - set: [ agent:energy, 0 ]
                    OnFalse:
                      - set: [ agent:frozen, conf:attack:freeze_duration ]
                      - reward: -1000

              - incr: stats:action:shield

    - Name: agent:init
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
            MetaData:
              met_1: 1
              met_2: 2
          2:
            VectorToDest: [ 0, 0 ]
            MetaData:
              met_1: 2
              met_2: 3
          3:
            VectorToDest: [ 0, 0 ]
            MetaData:
              met_1: 1
              met_2: 3

      Behaviours:
        - Src:
            Object: agent
          Dst:
            Object: agent
            Commands:
              - set: [ tmp:v1, 1 ]
              - set: [ tmp:v1, meta.met_1 ]
              - set: [ agent:id, _playerId ]
              - set: [ agent:energy, conf:agent:initial_energy ]
              - set: [ agent:met:1:resource, meta.met_1 ]
              - set: [ agent:met:2:resource, meta.met_2 ]

    - Name: agent:tick
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
      Behaviours:
        # Handle Time Passing
        - Src:
            Object: agent
          Dst:
            Object: agent
            Commands:
              - add: [ agent:energy, conf:agent:energy:regen ]
              - add: [ stats:energy:gained, conf:agent:energy:regen ]
              - set_tile: 0


              # handle shield upkeep
              - if:
                  Conditions:
                    eq: [ agent:shield, 1 ]
                  OnTrue:
                    - sub: [ agent:energy, conf:cost:shield:upkeep ]
                    - add: [ stats:energy:used:shield:upkeep, conf:cost:shield ]
                    - incr: stats:agent:shield:ticks
                    - set_tile: 1

              # record number of steps spent frozen
              - if:
                  Conditions:
                      neq: [ agent:frozen, 0 ]
                  OnTrue:
                    - incr: stats:agent:frozen:ticks
                    - sub: [ agent:energy, conf:cost:frozen ]
                    - add: [ stats:energy:used:frozen, conf:cost:frozen ]
                    - decr: agent:frozen
                    - set_tile: 2

              - if:
                  Conditions:
                      neq: [ render:agent:attacked, 0 ]
                  OnTrue:
                    - decr: render:agent:attacked
                    - set_tile: 3


              # maintain positive energy
              - if:
                  Conditions:
                    lt: [ agent:energy, 0 ]
                  OnTrue:
                    - set: [ agent:energy, 0 ]

              # update debug variables
              - set: [ debug:agent:energy, agent:energy ]
              - set: [ debug:agent:met:1, agent:met:2 ]
              - set: [ debug:agent:met:2, agent:met:2 ]

              - exec:
                  Action: agent:tick
                  ActionId: 1
                  Delay: 1


    - Name: generator:reset
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
            MetaData:
              mode: 1
          2:
            VectorToDest: [ 0, 0 ]
            MetaData:
              mode: 2
          3:
            VectorToDest: [ 0, 0 ]
            MetaData:
              mode: 3
      Behaviours:
        - Src:
            Object: generator
          Dst:
            Object: generator
            Commands:
              - set: [ generator:resource, meta.mode ]
              - set: [ generator:ready, 1 ]
              - set_tile: generator:resource

    - Name: charger:reset
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
      Behaviours:
        - Src:
            Object: charger
          Dst:
            Object: charger
            Commands:
              - set: [ charger:ready, 1 ]
              - set_tile: 0

    - Name: altar:reset
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
      Behaviours:
        - Src:
            Object: altar
          Dst:
            Object: altar
            Commands:
              - set: [ altar:ready, 1 ]
              - set_tile: 0

