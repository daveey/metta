  Version: '0.1'
  Environment:
    Name: PowerGrid
    Description: Metta - Foraging
    Variables:
      # Altar
      - Name: conf:altar:cooldown
        InitialValue: 2
      - Name: stats:action:use:altar
        InitialValue: 0
        PerPlayer: true
      # Charger
      - Name: conf:charger:energy
        InitialValue: 50
      - Name: conf:charger:cooldown
        InitialValue: 2
      - Name: stats:action:use:charger
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:gained:charger
        InitialValue: 0
        PerPlayer: true
      # Generator
      - Name: conf:generator:cooldown
        InitialValue: 50
      - Name: stats:action:use:generator
        InitialValue: 0
        PerPlayer: true

      # Agent Upkeep
      - Name: conf:agent:energy:regen
        InitialValue: 1
      - Name: conf:agent:initial_energy
        InitialValue: 100
      - Name: stats:action:use
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:gained
        InitialValue: 0
        PerPlayer: true

      # Movement
      - Name: conf:cost:move
        InitialValue: 0
      - Name: stats:action:move
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:move
        InitialValue: 0
        PerPlayer: true
      - Name: conf:cost:rotate
        InitialValue: 0
      - Name: stats:action:rotate
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:rotate
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:frozen
        InitialValue: 0
        PerPlayer: true
      - Name: stats:agent:frozen:ticks
        InitialValue: 0
        PerPlayer: true

      # Shield
      - Name: conf:cost:shield
        InitialValue: 0
      - Name: conf:cost:shield:upkeep
        InitialValue: 1
      - Name: stats:agent:shield:ticks
        InitialValue: 0
        PerPlayer: true
      - Name: stats:action:shield
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:shield:upkeep
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:shield:defence
        InitialValue: 0
        PerPlayer: true

      # Attack
      - Name: conf:cost:attack
        InitialValue: 20
      - Name: conf:attack:damage
        InitialValue: 15
      - Name: conf:attack:freeze_duration
        InitialValue: 15
      - Name: conf:cost:frozen
        InitialValue: 1
      - Name: stats:action:attack
        InitialValue: 0
        PerPlayer: true
      - Name: stats:energy:used:attack
        InitialValue: 0
        PerPlayer: true

      # Battery Stats
      - Name: stats:battery:collected
        InitialValue: 0
        PerPlayer: true
      - Name: stats:battery:used
        InitialValue: 0
        PerPlayer: true
      - Name: stats:battery:used:charger
        InitialValue: 0
        PerPlayer: true
      - Name: stats:battery:used:altar
        InitialValue: 0
        PerPlayer: true
      - Name: stats:battery:spawned
        InitialValue: 0

      # debug variables, used for webui
      - Name: debug:agent:energy
        InitialValue: 0
        PerPlayer: true
      - Name: debug:agent:frozen
        InitialValue: 0
        PerPlayer: true
      - Name: debug:agent:prestige
        InitialValue: 0
        PerPlayer: true
      - Name: debug:agent:shield
        InitialValue: 0
        PerPlayer: true

      # variables for controlling rendering
      - Name: render:agent:tile
        InitialValue: 0
        PerPlayer: true

    Observers:
      VectorAgent:
        Type: VECTOR
        Width: 11
        Height: 11
        TrackAvatar: true
        RotateWithAvatar: true
        IncludeVariables: true
        # IncludeRotation: true
      GlobalSpriteObserver:
        TileSize: 16
        Type: SPRITE_2D
        RotateAvatarImage: true
        BackgroundTile: oryx/oryx_fantasy/floor1-1.png
        Shader:
            ObjectVariables: [ agent:energy, agent:energy ]
            ObserverAvatarMode: DARKEN
    Player:
      Count: 7
      AvatarObject: agent

    Levels:
      - >
        W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W
        W

        W   A1   .   .   .   .   a   .   .   A2  .   .   .   .   .   .   .   A3
        W

        W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   .   .   .   .   .   c   .   a   .   .   .   .   .   .   .   .   .
        W

        W   .   .   g   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   .   .   .   .   .   c   .   .   .   .   g   .   .   .   .   .   .
        W

        W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   A4   .   g   .   .   .   .   .   g   .   .   .   .   .   g   .   A5
        W

        W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   .   .   .   .   .   g   .   .   .   .   .   .   .   .   .   .   .
        W

        W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   .   .   .   .   .   .   .   .   g   .   .   g   .   .   .   .   .
        W

        W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
        W

        W   A6   .   .   .   .   .   .   .   .   A7   .   .   .   .   .   .   .
        W

        W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W
        W

  Objects:
    - Name: wall
      MapCharacter: W
      Z: 1
      Observers:
        GlobalSpriteObserver:
          - TilingMode: WALL_16
            Image:
              - oryx/oryx_fantasy/wall2-0.png
              - oryx/oryx_fantasy/wall2-1.png
              - oryx/oryx_fantasy/wall2-2.png
              - oryx/oryx_fantasy/wall2-3.png
              - oryx/oryx_fantasy/wall2-4.png
              - oryx/oryx_fantasy/wall2-5.png
              - oryx/oryx_fantasy/wall2-6.png
              - oryx/oryx_fantasy/wall2-7.png
              - oryx/oryx_fantasy/wall2-8.png
              - oryx/oryx_fantasy/wall2-9.png
              - oryx/oryx_fantasy/wall2-10.png
              - oryx/oryx_fantasy/wall2-11.png
              - oryx/oryx_fantasy/wall2-12.png
              - oryx/oryx_fantasy/wall2-13.png
              - oryx/oryx_fantasy/wall2-14.png
              - oryx/oryx_fantasy/wall2-15.png

    - Name: generator
      Z: 1
      MapCharacter: g
      Variables:
        - Name: generator:ready
          InitialValue: 0
        - Name: generator:mode
          InitialValue: 1
      Observers:
        GlobalSpriteObserver:
          - Image: oryx/oryx_fantasy/ore-0.png
          - Image: oryx/oryx_fantasy/ore-1.png
          - Image: oryx/oryx_fantasy/ore-2.png
          - Image: oryx/oryx_fantasy/ore-3.png
          - Image: oryx/oryx_fantasy/ore-4.png
          - Image: oryx/oryx_fantasy/ore-5.png
          - Image: oryx/oryx_fantasy/ore-6.png
      InitialActions:
        - Action: generator:reset
          ActionId: 1

    - Name: charger
      Z: 1
      MapCharacter: c
      Variables:
        - Name: charger:ready
          InitialValue: 0
      Observers:
        GlobalSpriteObserver:
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_pda_A.png
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_pda_B.png
      InitialActions:
        - Action: charger:reset
          ActionId: 1

    - Name: altar
      Z: 1
      MapCharacter: a
      Variables:
        - Name: altar:ready
          InitialValue: 0
      Observers:
        GlobalSpriteObserver:
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_heart_clear.png
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_items/tg_items_heart_full.png
      InitialActions:
        - Action: altar:reset
          ActionId: 1

    - Name: agent
      MapCharacter: A
      Z: 10
      Variables:
        - Name: agent:id
          InitialValue: 0
        - Name: agent:energy
          InitialValue: 0
        - Name: agent:prestige
          InitialValue: 0
        - Name: agent:inv:battery
          InitialValue: 0
        - Name: agent:frozen
          InitialValue: 0
        - Name: agent:shield
          InitialValue: 0

      Observers:
        GlobalSpriteObserver:
          # Shield off
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_astronaut_u1.png
          # Shield on
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_beast_u1.png
          # Frozen
          - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_bug_u1.png

      InitialActions:
        - Action: agent:tick
          Delay: 1
          ActionId: 1
        - Action: agent:init
          ActionId: 1

  Actions:
    - Name: rotate
      InputMapping:
          Inputs:
            1:
              Description: Face down
              OrientationVector: [0, 1]
            2:
              Description: Face left
              OrientationVector: [-1, 0]
            3:
              Description: Face right
              OrientationVector: [1, 0]
            4:
              Description: Face Up
              OrientationVector: [0, -1]

      Behaviours:
        - Src:
            Object: agent
            Preconditions:
              - gte: [ agent:energy, conf:cost:rotate ]
              - eq: [ agent:frozen, 0 ]
            Commands:
              - rot: _dir
              - sub: [ agent:energy, conf:cost:rotate ]
              - incr: stats:action:rotate
              - add: [ stats:energy:used:rotate, conf:cost:rotate ]
          Dst:
            Object: agent


    - Name: move
      InputMapping:
        Relative: true
        Inputs:
          1:
            VectorToDest: [ 0, -1 ]
            Description: "move forward"
          2:
            VectorToDest: [ 0, 1 ]
            Description: "move backward"

      Behaviours:
        - Src:
            Object: agent
            Preconditions:
              - gte: [ agent:energy, conf:cost:move ]
              - eq: [ agent:frozen, 0 ]
            Commands:
              - sub: [ agent:energy, conf:cost:move ]
              - incr: stats:action:move
              - add: [ stats:energy:used:move, conf:cost:move ]
              - mov: _dest
          Dst:
            Object: [ _empty ]

    - Name: use
      InputMapping:
        Relative: true
        Inputs:
          1:
            VectorToDest: [ 0, -1 ]
            Description: "use"
      Behaviours:
        # Use a generator
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
                - eq: [ dst.generator:ready, 1 ]
            Commands:
              - incr: stats:action:use:generator
              - add: [ agent:inv:battery, 1 ]
              - incr: stats:battery:collected
          Dst:
            Object: generator
            Commands:
              - set_tile: 0
              - set: [ generator:ready, 0 ]
              - exec:
                  Action: generator:reset
                  ActionId: 1
                  Delay: conf:generator:cooldown

        # Use a charger
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
                - eq: [ dst.charger:ready, 1 ]
                - gte: [ agent:inv:battery, 1 ]
            Commands:
              - incr: stats:action:use:charger
              - add: [ agent:energy, conf:charger:energy ]
              - add: [ stats:energy:gained:charger, conf:charger:energy ]
              - add: [ stats:energy:gained, conf:charger:energy ]
              - sub: [ agent:inv:battery, 1 ]
              - incr: stats:battery:used
              - incr: stats:battery:used:charger
          Dst:
            Object: charger
            Commands:
              - set_tile: 1
              - set: [ charger:ready, 0 ]
              - exec:
                  Action: charger:reset
                  ActionId: 1
                  Delay: conf:charger:cooldown

        # Use Altar
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
                - eq: [ dst.altar:ready, 1 ]
                - gte: [ agent:inv:battery, 1 ]
            Commands:
              - incr: stats:action:use:altar
              - sub: [ agent:inv:battery, 1 ]
              - incr: agent:prestige
              - incr: stats:battery:used:altar
              - reward: 1
          Dst:
            Object: altar
            Commands:
              - set_tile: 1
              - set: [ altar:ready, 0 ]
              - exec:
                  Action: altar:reset
                  ActionId: 1
                  Delay: conf:altar:cooldown

    - Name: shield
      InputMapping:
        Relative: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
            Description: "Toggle Shield"

      Behaviours:
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
            Commands:
              - if:
                    Conditions:
                      eq: [ agent:shield, 1 ]
                    OnTrue:
                      - set: [ agent:shield, 0 ]
                    OnFalse:
                      - set: [ agent:shield, 1 ]

              - incr: stats:action:shield
          Dst:
            Object: agent

    - Name: attack
      InputMapping:
        Relative: true
        Inputs:
          1:
            VectorToDest: [ -1, -1 ]
            Description: "attack 1"
          2:
            VectorToDest: [ 0, -1 ]
            Description: "attack 2"
          3:
            VectorToDest: [ 1, -1 ]
            Description: "attack 3"
          4:
            VectorToDest: [ -1, -2 ]
            Description: "attack 4"
          5:
            VectorToDest: [ 0, -2 ]
            Description: "attack 5"
          6:
            VectorToDest: [ 1, -2 ]
            Description: "attack 6"
          7:
            VectorToDest: [ -1, -3 ]
            Description: "attack 7"
          8:
            VectorToDest: [ 0, -3 ]
            Description: "attack 8"
          9:
            VectorToDest: [ 1, -3 ]
            Description: "attack 9"

      Behaviours:
        - Src:
            Object: agent
            Preconditions:
              - and:
                - eq: [ agent:frozen, 0 ]
                - gte: [ agent:energy, conf:cost:attack ]
            Commands:
              - sub: [ agent:energy, conf:cost:attack ]
              - add: [ stats:energy:used:attack, conf:cost:attack ]
              - incr: stats:action:attack

          Dst:
            Object: agent
            Commands:
              - if:
                    Conditions:
                      eq: [ agent:shield, 1 ]
                    OnTrue:
                      - sub: [ agent:energy, conf:attack:damage ]
                      - add: [ stats:energy:used:shield:defence, conf:attack:damage ]
                      - if:
                          Conditions:
                            lt: [ agent:energy, 0 ]
                          OnTrue:
                            - set: [ agent:frozen, conf:attack:freeze_duration ]
                            - set: [ agent:shield, 0 ]
                            - set: [ agent:energy, 0 ]
                    OnFalse:
                      - set: [ agent:frozen, conf:attack:freeze_duration ]

              - incr: stats:action:shield

    - Name: agent:init
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
      Behaviours:
        - Src:
            Object: agent
          Dst:
            Object: agent
            Commands:
              - set: [ agent:id, _playerId ]
              - set: [ agent:energy, conf:agent:initial_energy ]

    - Name: agent:tick
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
      Behaviours:
        # Handle Time Passing
        - Src:
            Object: agent
          Dst:
            Object: agent
            Commands:
              - add: [ agent:energy, conf:agent:energy:regen ]
              - add: [ stats:energy:gained, conf:agent:energy:regen ]
              - set: [ render:agent:tile, 0 ]

              # handle shield upkeep
              - if:
                  Conditions:
                    eq: [ agent:shield, 1 ]
                  OnTrue:
                    - sub: [ agent:energy, conf:cost:shield:upkeep ]
                    - add: [ stats:energy:used:shield:upkeep, conf:cost:shield ]
                    - incr: stats:agent:shield:ticks
                    - set: [ render:agent:tile, 1 ]

              # record number of steps spent frozen
              - if:
                  Conditions:
                      neq: [ agent:frozen, 0 ]
                  OnTrue:
                    - incr: stats:agent:frozen:ticks
                    - sub: [ agent:energy, conf:cost:frozen ]
                    - add: [ stats:energy:used:frozen, conf:cost:frozen ]
                    - decr: agent:frozen
                    - set: [ render:agent:tile, 2 ]

              # update agent sprite
              - set_tile: render:agent:tile

              # maintain positive energy
              - if:
                  Conditions:
                    lt: [ agent:energy, 0 ]
                  OnTrue:
                    - set: [ agent:energy, 0 ]

              # update debug variables
              - set: [ debug:agent:energy, agent:energy ]
              - set: [ debug:agent:prestige, agent:prestige ]
              - set: [ debug:agent:frozen, agent:frozen ]
              - set: [ debug:agent:shield, agent:shield ]

              - exec:
                  Action: agent:tick
                  ActionId: 1
                  Delay: 1


    - Name: generator:reset
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
      Behaviours:
        - Src:
            Object: generator
          Dst:
            Object: generator
            Commands:
              - set: [ generator:ready, 1 ]
              - set_tile: 1

    - Name: charger:reset
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
      Behaviours:
        - Src:
            Object: charger
          Dst:
            Object: charger
            Commands:
              - set: [ charger:ready, 1 ]
              - set_tile: 0

    - Name: altar:reset
      InputMapping:
        Internal: true
        Inputs:
          1:
            VectorToDest: [ 0, 0 ]
      Behaviours:
        - Src:
            Object: altar
          Dst:
            Object: altar
            Commands:
              - set: [ altar:ready, 1 ]
              - set_tile: 0

