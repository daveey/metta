Version: '0.1'
Environment:
  Name: OrbWorld2
  Description: Metta - Foraging
  Variables:
    # number of agents with energy, used for termination checks
    - Name: num_active_agents
      InitialValue: 0

    - Name: conf:orb:energy
      InitialValue: 50
    - Name: conf:orb_factory:cooldown
      InitialValue: 50

    - Name: conf:agent:initial_energy
      InitialValue: 100

    - Name: conf:cost:move
      InitialValue: 1
    - Name: conf:cost:get
      InitialValue: 1
    - Name: conf:cost:use
      InitialValue: 1
    - Name: conf:cost:prestige
      InitialValue: 50
    - Name: conf:cost:prestige:margin
      InitialValue: 10

    - Name: stats:orbs:collected
      InitialValue: 0
      PerPlayer: true
    - Name: stats:orbs:used
      InitialValue: 0
      PerPlayer: true
    - Name: stats:orbs:spawned
      InitialValue: 0

    - Name: stats:agent:energy
      InitialValue: 0
      PerPlayer: true
    - Name: stats:agent:energy:max
      InitialValue: 0
    - Name: stats:agent:prestige
      InitialValue: 0
      PerPlayer: true
    - Name: stats:agent:prestige:max
      InitialValue: 0

  Observers:
    VectorAgent:
      Type: VECTOR
      Width: 15
      Height: 15
      TrackAvatar: true
      IncludeVariables: true
      # IncludePlayerId: true
    GlobalSpriteObserver:
      TileSize: 16
      HighlightPlayers: true
      Type: SPRITE_2D
      Shader:
        ObserverAvatarMode: DARKEN
    GlobalBlockObserver:
      TileSize: 16
      Type: BLOCK_2D
      Shader:
        ObserverAvatarMode: GRAYSCALE
  Player:
    Count: 7
    AvatarObject: agent

  Levels:
    - >
      W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W
      W

      W   A1   .   .   .   .   .   .   .   A2  .   .   .   .   .   .   .   A3
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   o   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   .   .   o   .   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   A4   .   o   .   .   .   .   .   o   .   .   .   .   .   o   .   A5
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   .   .   .   o   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   o   .   .   o   .   .   .   .   .
      W

      W   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .
      W

      W   A6   .   .   .   .   .   .   .   .   A7   .   .   .   .   .   .   .
      W

      W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W   W
      W

Objects:
  - Name: wall
    MapCharacter: W
    Z: 1
    Observers:
      GlobalSpriteObserver:
        - TilingMode: WALL_16
          Image:
            - oryx/oryx_fantasy/wall2-0.png
            - oryx/oryx_fantasy/wall2-1.png
            - oryx/oryx_fantasy/wall2-2.png
            - oryx/oryx_fantasy/wall2-3.png
            - oryx/oryx_fantasy/wall2-4.png
            - oryx/oryx_fantasy/wall2-5.png
            - oryx/oryx_fantasy/wall2-6.png
            - oryx/oryx_fantasy/wall2-7.png
            - oryx/oryx_fantasy/wall2-8.png
            - oryx/oryx_fantasy/wall2-9.png
            - oryx/oryx_fantasy/wall2-10.png
            - oryx/oryx_fantasy/wall2-11.png
            - oryx/oryx_fantasy/wall2-12.png
            - oryx/oryx_fantasy/wall2-13.png
            - oryx/oryx_fantasy/wall2-14.png
            - oryx/oryx_fantasy/wall2-15.png

  - Name: orb_factory
    Z: 1
    MapCharacter: o
    Variables:
      - Name: orb_factory:ready
        InitialValue: 0
      - Name: orb_factory:mode
        InitialValue: 1
    Observers:
      GlobalSpriteObserver:
        - Image: oryx/oryx_fantasy/ore-0.png
        - Image: oryx/oryx_fantasy/ore-1.png
        - Image: oryx/oryx_fantasy/ore-2.png
        - Image: oryx/oryx_fantasy/ore-3.png
        - Image: oryx/oryx_fantasy/ore-4.png
        - Image: oryx/oryx_fantasy/ore-5.png
        - Image: oryx/oryx_fantasy/ore-6.png
    InitialActions:
      - Action: orb_factory:spawn
        ActionId: 1

  - Name: agent
    MapCharacter: A
    Z: 10
    Variables:
      - Name: agent:id
        InitialValue: 0
      - Name: agent:energy
        InitialValue: 0
      - Name: agent:prestige
        InitialValue: 0
      - Name: agent:inv:orbs
        InitialValue: 0

    Observers:
      GlobalSpriteObserver:
        - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_astronaut_l1.png
        - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_astronaut_u1.png
        - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_astronaut_r1.png
        - Image: oryx/oryx_tiny_galaxy/tg_sliced/tg_monsters/tg_monsters_astronaut_d1.png
    InitialActions:
      - Action: agent:tick
        Delay: 1
        ActionId: 1
      - Action: agent:init
        ActionId: 1


Actions:
  - Name: move
    InputMapping:
      Inputs:
        1:
          OrientationVector: [ -1, 0 ]
          VectorToDest: [ -1, 0 ]
          Description: "Move Left"
          MetaData:
            image_idx: 0
        2:
          OrientationVector: [ 0, -1 ]
          VectorToDest: [ 0, -1 ]
          Description: "Move Up"
          MetaData:
            image_idx: 1
        3:
          OrientationVector: [ 1, 0 ]
          VectorToDest: [ 1, 0 ]
          Description: "Move Right"
          MetaData:
            image_idx: 2
        4:
          OrientationVector: [ 0, 1 ]
          VectorToDest: [ 0, 1 ]
          Description: "Move Down"
          MetaData:
            image_idx: 3
    Behaviours:
      - Src:
          Object: agent
          Preconditions:
            - gte: [agent:energy, conf:cost:move]
          Commands:
            - sub: [ agent:energy, conf:cost:move ]
            - mov: _dest
            - rot: _dir
            - set_tile: meta.image_idx
        Dst:
          Object: [ _empty ]

      - Src:
          Object: agent
          Commands:
            - rot: _dir
            - set_tile: meta.image_idx
        Dst:
          Object: [ wall,  agent, orb_factory ]

  - Name: get
    InputMapping:
      Relative: true
      Inputs:
        1:
          VectorToDest: [ 0, -1 ]
          Description: "pickup the current object"
    Behaviours:
      # Player collects an orb
      - Src:
          Object: agent
          Preconditions:
            - and:
              - gte: [  agent:energy, conf:cost:get ]
              - eq: [ dst.orb_factory:ready, 1 ]
          Commands:
            - sub: [ agent:energy, conf:cost:get ]
            - add: [ agent:inv:orbs, 1 ]
            - incr: stats:orbs:collected
        Dst:
          Object: orb_factory
          Commands:
            - set_tile: 0
            - set: [ orb_factory:ready, 0 ]
            - exec:
                Action: orb_factory:spawn
                ActionId: 1
                Delay: conf:orb_factory:cooldown

  - Name: use
    InputMapping:
      Relative: true
      Inputs:
        1:
          VectorToDest: [ 0, 0 ]
          Description: "Consume"
          MetaData:
            action_id: 1

    Behaviours:
      - Src:
          Object: agent
          Preconditions:
            - and:
              - gte: [agent:energy, conf:cost:use]
              - eq: [ meta.action_id, 1 ]
              - gt: [ agent:inv:orbs, 0 ]
          Commands:
            - sub: [ agent:energy, conf:cost:use ]
            - decr: agent:inv:orbs
            - add: [ agent:energy, conf:orb:energy ]
            - incr: stats:orbs:used
        Dst:
          Object: agent

  - Name: prestige
    InputMapping:
      Relative: true
      Inputs:
        1:
          VectorToDest: [ 0, 0 ]
          Description: "Increase Prestige"
          MetaData:
            action_id: 1

    Behaviours:
      - Src:
          Object: agent
          Preconditions:
            - and:
              - gte: [ agent:energy, conf:cost:prestige ]
              - eq: [ meta.action_id, 1 ]
          Commands:
            - incr: agent:prestige
            - sub: [ agent:energy, conf:cost:prestige ]
            - add: [ conf:cost:prestige, conf:cost:prestige:margin ]
            - reward: 1
        Dst:
          Object: agent

  - Name: agent:init
    InputMapping:
      Internal: true
      Inputs:
        1:
          VectorToDest: [ 0, 0 ]
    Behaviours:
      - Src:
          Object: agent
        Dst:
          Object: agent
          Commands:
            - set: [ agent:id, _playerId ]
            - set: [ agent:energy, conf:agent:initial_energy ]
            - incr: num_active_agents

  - Name: agent:tick
    InputMapping:
      Internal: true
      Inputs:
        1:
          VectorToDest: [ 0, 0 ]
    Behaviours:

      # Just repeat this action every time step
      - Src:
          Object: agent
        Dst:
          Object: agent
          Commands:
            - exec:
                Action: agent:tick
                ActionId: 1
                Delay: 1

      # Handle Time Passing
      - Src:
          Object: agent
        Dst:
          Object: agent
          Commands:
            - incr: agent:energy
            - set: [ stats:agent:energy, agent:energy ]
            - set: [ stats:agent:prestige, agent:prestige ]
            - if:
                Conditions:
                    gt: [ agent:energy, stats:agent:energy:max]
                OnTrue:
                  - set: [ stats:agent:energy:max, agent:energy]
            - if:
                Conditions:
                    gt: [ agent:prestige, stats:agent:prestige:max ]
                OnTrue:
                  - set: [ stats:agent:prestige:max,  agent:prestige ]

  - Name: orb_factory:spawn
    InputMapping:
      Internal: true
      Inputs:
        1:
          VectorToDest: [ 0, 0 ]
    Behaviours:

      # Just repeat this action every time step
      - Src:
          Object: orb_factory
        Dst:
          Object: orb_factory
          Commands:
            - set: [orb_factory:ready, 1]
            - incr: [ stats:orbs:spawned ]
            - set_tile: 1
